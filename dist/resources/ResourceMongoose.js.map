{"version":3,"sources":["../../src/resources/ResourceMongoose.js"],"names":["ResourceMongoose","Config","mongoose","Object","seal","ObjectId","Implementation","config","configure","query","Promise","resolve","then","dbQuery","constructMongoQuery","$page","$offset","$limit","$sort","parseInt","Infinity","keys","length","Model","find","sort","skip","limit","populate","documents","map","transformDocumentToPlainObject","payload","doc","save","options","findOneAndUpdate","upsert","Boolean","findOne","_doc","findOneAndRemove","key","value","Array","isArray","$in","pageNumber","entriesPerPage","document","obj","toObject","virtuals","_id","__v","stripMongoCruft","toString","Date","toISOString"],"mappings":"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","file":"ResourceMongoose.js","sourcesContent":["import {Types}          from 'mongoose';\n\nimport ResourceBase     from './ResourceBase';\nimport ConfigRoot       from '../config/ConfigRoot';\nimport ConfigMongoose   from '../config/ConfigMongoose';\nimport IResource        from '../interfaces/IResource';\n\nclass ResourceMongoose extends IResource {}\n\nconst Config = class extends ConfigRoot {\n    constructor() {\n        super();\n\n        this.mongoose = new ConfigMongoose();\n\n        Object.seal(this);\n    }\n};\n\nconst {ObjectId} = Types;\n\nResourceMongoose.Implementation = class extends ResourceBase {\n    constructor(config) {\n        super();\n\n        this.configure(config, Config);\n\n        Object.seal(this);\n    }\n\n    /**\n     * Implements the service call for this type of resource.\n     *\n     * @private\n     * @param   {object} query\n     * @return  {object[]}\n     */\n\n    queryService(query={}) {\n        return Promise.resolve()\n            .then(() => {\n                const dbQuery = constructMongoQuery(query);\n\n                let $page   = 1;\n                let $offset = 0;\n                let $limit  = 100;\n                let $sort   = '';\n\n                if (query.$limit && query.$page) {\n                    $page  = parseInt(query.$page);\n                    $limit = parseInt(query.$limit);\n\n                    if ($limit < Infinity) {\n                        $offset = $limit * ($page - 1);\n                    }\n\n                    $sort = '-_id';\n                } else if (query.$limit && typeof query.$offset === 'number') {\n                    $limit = query.$limit;\n                    $offset = query.$offset;\n                }\n\n                if (!Object.keys(query).length) {\n                    $sort = '-_id';\n                }\n\n                return this.config.mongoose.Model.find(dbQuery, '-__v')\n                    .sort($sort)\n                    .skip($offset)\n                    .limit($limit)\n                    .populate(this.config.mongoose.populate)\n                    .then(documents => documents.map(transformDocumentToPlainObject));\n            });\n    }\n\n    /**\n     * @public\n     * @param   {object} payload\n     * @return  {Promise<object>}\n     */\n\n    create(payload) {\n        const doc = new this.config.mongoose.Model(payload);\n\n        return doc.save()\n            .then(transformDocumentToPlainObject);\n    }\n\n    /**\n     * @public\n     * @param   {object}    query\n     * @param   {object}    payload\n     * @param   {object}   [options={}]\n     * @return  {Promise}\n     */\n\n    update(query, payload, options={}) {\n        const dbQuery = constructMongoQuery(query);\n\n        return this.config.mongoose.Model.findOneAndUpdate(dbQuery, payload, {\n            upsert: Boolean(options.upsert)\n        })\n            .then(transformDocumentToPlainObject);\n    }\n\n    /**\n     * @public\n     * @param   {object}    query\n     * @return  {Promise}\n     */\n\n    delete(query) {\n        const dbQuery = constructMongoQuery(query);\n\n        let doc = null;\n\n        return this.config.mongoose.Model.findOne(dbQuery, '-__v')\n            .then(_doc => {\n                doc = _doc;\n\n                return this.config.mongoose.Model.findOneAndRemove(dbQuery);\n            })\n            .then(() => transformDocumentToPlainObject(doc));\n    }\n};\n\n/**\n * @private\n * @static\n * @param   {object}    query\n * @return  {object}\n */\n\nfunction constructMongoQuery(query) {\n    const dbQuery = {};\n\n    for (let key in query) {\n        let value = query[key];\n\n        if (Array.isArray(value)) {\n            value = {\n                $in: value\n            };\n        }\n\n        if (key === 'id') {\n            // Rename id to _id if present in query\n\n            dbQuery['_id'] = value;\n        } else {\n            dbQuery[key] = value;\n        }\n    }\n\n    delete dbQuery.pageNumber;\n    delete dbQuery.entriesPerPage;\n\n    return dbQuery;\n}\n\n/**\n * @private\n * @static\n * @param   {Document} document\n * @return  {object}\n */\n\nfunction transformDocumentToPlainObject(document) {\n    const obj = document.toObject({\n        virtuals: true\n    });\n\n    delete obj._id;\n    delete obj.__v;\n\n    stripMongoCruft(obj);\n}\n\n/**\n * Converts any MongDB types to strings.\n *\n * @private\n * @param {object} obj\n */\n\nfunction stripMongoCruft(obj) {\n    for (let key in obj) {\n        const value = obj[key];\n\n        if (!value) continue;\n\n        if (value instanceof ObjectId) {\n            obj[key] = value.toString();\n        } else if (value instanceof Date) {\n            obj[key] = value.toISOString();\n        } else if (typeof value === 'object') {\n            stripMongoCruft(value);\n        }\n    }\n}\n\nexport default ResourceMongoose;"]}