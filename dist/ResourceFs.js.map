{"version":3,"sources":["../src/ResourceFs.js"],"names":["ResourceFs","arguments","Private","config","extension","Error","charAt","configure","root","resolve","path","query","alias","nameAlias","hasQuery","transform","name","transformQuery","Object","keys","length","getFilesByName","getAllFiles","names","Array","isArray","Promise","all","map","getFileByName","bind","extRe","RegExp","match","replace","filePath","join","reject","readFile","err","data","then","buffer","toString","file","JSON","parse","contents","transformResponse","readdir","list","filter","fileName","filenames"],"mappings":";;;;;;;;AAAA;;;;AACA;;;;AAEA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;;;;;IAEMA,U;;;AACF,0BAAc;AAAA;;AAAA,wHACDC,SADC;AAEb;;;;;AAGLD,WAAWE,OAAX;AAAA;;AACI,yBAAYC,MAAZ,EAAoB;AAAA;;AAAA;;AAGhB,YAAI,CAACA,OAAOC,SAAZ,EAAuB;AACnB,kBAAM,IAAIC,KAAJ,CAAU,2CAAV,CAAN;AACH;;AAED,YAAIF,OAAOC,SAAP,CAAiBE,MAAjB,CAAwB,CAAxB,MAA+B,GAAnC,EAAwC;AACpCH,mBAAOC,SAAP,GAAmB,MAAMD,OAAOC,SAAhC;AACH;;AAED,eAAKG,SAAL,CAAeJ,MAAf;;AAEA,eAAKK,IAAL,GAAY,eAAKC,OAAL,CAAa,OAAKN,MAAL,CAAYO,IAAzB,CAAZ;AAbgB;AAcnB;;AAED;;;;;;;;AAjBJ;AAAA;AAAA,uCAyB2B;AAAA,gBAAVC,KAAU,uEAAJ,EAAI;;AACnB,gBAAMC,QAAQ,KAAKT,MAAL,CAAYU,SAA1B;;AAEA,gBAAIC,WAAY,KAAhB;AACA,gBAAIC,YAAY,IAAhB;AACA,gBAAIC,OAAY,EAAhB;;AAEA,gBAAI,QAAQD,YAAY,KAAKZ,MAAL,CAAYc,cAAhC,MAAoD,UAAxD,EAAoE;AAChEN,wBAAQI,UAAUJ,KAAV,CAAR;AACH;;AAEDG,uBAAWI,OAAOC,IAAP,CAAYR,KAAZ,EAAmBS,MAA9B;;AAEA,gBAAIN,YAAY,OAAOH,MAAMK,IAAb,KAAsB,WAAtC,EAAmD;AAC/C,oBAAIJ,UAAUI,OAAOL,MAAMC,KAAN,CAAjB,CAAJ,EAAoC;AAChC;;AAEAD,4BAAQ,EAACK,UAAD,EAAR;AACH,iBAJD,MAIO;AACH,0BAAM,IAAIX,KAAJ,CAAU,6EAAV,CAAN;AACH;AACJ;;AAED,gBAAIS,QAAJ,EAAc;AACV,uBAAO,KAAKO,cAAL,CAAoBV,KAApB,CAAP;AACH;;AAED,mBAAO,KAAKW,WAAL,EAAP;AACH;;AAED;;;;;;AAvDJ;AAAA;AAAA,uCA6DmBX,KA7DnB,EA6D0B;AAClB,gBAAIY,QAAQZ,MAAMK,IAAlB;;AAEA,gBAAI,CAACQ,MAAMC,OAAN,CAAcF,KAAd,CAAL,EAA2B;AACvBA,wBAAQ,CAACA,KAAD,CAAR;AACH;;AAED,mBAAOG,QAAQC,GAAR,CAAYJ,MAAMK,GAAN,CAAU,KAAKC,aAAL,CAAmBC,IAAnB,CAAwB,IAAxB,CAAV,CAAZ,CAAP;AACH;;AAED;;;;;;AAvEJ;AAAA;AAAA,sCA6EkBd,IA7ElB,EA6EwB;AAAA;;AAChB,gBAAMe,QAAQ,IAAIC,MAAJ,CAAW,KAAK7B,MAAL,CAAYC,SAAZ,GAAwB,GAAnC,EAAwC,GAAxC,CAAd;;AAEA,gBAAIY,KAAKiB,KAAL,CAAWF,KAAX,CAAJ,EAAuB;AACnB;;AAEAf,uBAAOA,KAAKkB,OAAL,CAAaH,KAAb,EAAoB,EAApB,CAAP;AACH;;AAED,gBAAMI,WAAW,eAAKC,IAAL,CAAU,KAAK5B,IAAf,EAAqBQ,OAAO,KAAKb,MAAL,CAAYC,SAAxC,CAAjB;;AAEA,mBAAO,IAAIsB,OAAJ,CAAY,UAACjB,OAAD,EAAU4B,MAAV,EAAqB;AACpC,kCAAGC,QAAH,CAAYH,QAAZ,EAAsB,UAACI,GAAD,EAAMC,IAAN;AAAA,2BAAeD,MAAMF,OAAOE,GAAP,CAAN,GAAoB9B,QAAQ+B,IAAR,CAAnC;AAAA,iBAAtB;AACH,aAFM,EAGFC,IAHE,CAGG;AAAA,uBAAU,mBAASzB,IAAT,EAAe0B,OAAOC,QAAP,EAAf,CAAV;AAAA,aAHH,EAIFF,IAJE,CAIG,gBAAQ;AACV,oBAAI,OAAKtC,MAAL,CAAYC,SAAZ,KAA0B,OAA9B,EAAuC,OAAOwC,IAAP;;AAEvC,uBAAOC,KAAKC,KAAL,CAAWF,KAAKG,QAAhB,CAAP;AACH,aARE,EASFN,IATE,CASG,gBAAQ;AACV,uBAAO,OAAKO,iBAAL,CAAuBJ,IAAvB,CAAP;AACH,aAXE,CAAP;AAYH;;AAED;;;;;AAtGJ;AAAA;AAAA,sCA2GkB;AAAA;;AACV,mBAAO,IAAIlB,OAAJ,CAAY,UAACjB,OAAD,EAAU4B,MAAV,EAAqB;AACpC,kCAAGY,OAAH,CAAW,OAAKzC,IAAhB,EAAsB,UAAC+B,GAAD,EAAMW,IAAN;AAAA,2BAAeX,MAAMF,OAAOE,GAAP,CAAN,GAAoB9B,QAAQyC,IAAR,CAAnC;AAAA,iBAAtB;AACH,aAFM,EAGFT,IAHE,CAGG,gBAAQ;AACV;AACA;;AAEA,uBAAOS,KAAKC,MAAL,CAAY,oBAAY;AAC3B,2BAAOC,SAASnB,KAAT,CAAe,QAAf,KAA4BmB,SAASnB,KAAT,CAAe,IAAID,MAAJ,CAAW,OAAK7B,MAAL,CAAYC,SAAZ,GAAwB,GAAnC,EAAwC,GAAxC,CAAf,CAAnC;AACH,iBAFM,CAAP;AAGH,aAVE,EAWFqC,IAXE,CAWG;AAAA,uBAAaf,QAAQC,GAAR,CAAY0B,UAAUzB,GAAV,CAAc,OAAKC,aAAL,CAAmBC,IAAnB,QAAd,CAAZ,CAAb;AAAA,aAXH,CAAP;AAYH;AAxHL;;AAAA;AAAA;;kBA2He9B,U","file":"ResourceFs.js","sourcesContent":["import path         from 'path';\nimport fs           from 'fs-extra';\n\nimport ResourceBase from './ResourceBase';\nimport ConfigFs     from './ConfigFs';\nimport IResource    from './IResource';\nimport File         from './File';\n\nclass ResourceFs extends IResource {\n    constructor() {\n        super(...arguments);\n    }\n}\n\nResourceFs.Private = class _ResourceFs extends ResourceBase {\n    constructor(config) {\n        super();\n\n        if (!config.extension) {\n            throw new Error('[resource-fs] No file extension specified');\n        }\n\n        if (config.extension.charAt(0) !== '.') {\n            config.extension = '.' + config.extension;\n        }\n\n        this.configure(config, ConfigFs);\n\n        this.root = path.resolve(this.config.path);\n    }\n\n    /**\n     * Implements the service call for this type of resource.\n     *\n     * @private\n     * @param   {object} query\n     * @return  {object[]}\n     */\n\n    queryService(query={}) {\n        const alias = this.config.nameAlias;\n\n        let hasQuery  = false;\n        let transform = null;\n        let name      = '';\n\n        if (typeof (transform = this.config.transformQuery) === 'function') {\n            query = transform(query);\n        }\n\n        hasQuery = Object.keys(query).length;\n\n        if (hasQuery && typeof query.name === 'undefined') {\n            if (alias && (name = query[alias])) {\n                // Create new aliased query to preserve cache keys\n\n                query = {name};\n            } else {\n                throw new Error('[resource-fs] Files may only be queried by `name`. Please provide an alias.');\n            }\n        }\n\n        if (hasQuery) {\n            return this.getFilesByName(query);\n        }\n\n        return this.getAllFiles();\n    }\n\n    /**\n     * @private\n     * @param   {object} query\n     * @return  {Promise}\n     */\n\n    getFilesByName(query) {\n        let names = query.name;\n\n        if (!Array.isArray(names)) {\n            names = [names];\n        }\n\n        return Promise.all(names.map(this.getFileByName.bind(this)));\n    }\n\n    /**\n     * @private\n     * @param   {string} name\n     * @return  {Promise}\n     */\n\n    getFileByName(name) {\n        const extRe = new RegExp(this.config.extension + '$', 'g');\n\n        if (name.match(extRe)) {\n            // Strip extension from filename is present\n\n            name = name.replace(extRe, '');\n        }\n\n        const filePath = path.join(this.root, name + this.config.extension);\n\n        return new Promise((resolve, reject) => {\n            fs.readFile(filePath, (err, data) => err ? reject(err) : resolve(data));\n        })\n            .then(buffer => new File(name, buffer.toString()))\n            .then(file => {\n                if (this.config.extension !== '.json') return file;\n\n                return JSON.parse(file.contents);\n            })\n            .then(file => {\n                return this.transformResponse(file);\n            });\n    }\n\n    /**\n     * @private\n     * @return  {Promise}\n     */\n\n    getAllFiles() {\n        return new Promise((resolve, reject) => {\n            fs.readdir(this.root, (err, list) => err ? reject(err) : resolve(list));\n        })\n            .then(list => {\n                // Filter out system files and files not matching the\n                // specified extension\n\n                return list.filter(fileName => {\n                    return fileName.match(/^[^.]/g) && fileName.match(new RegExp(this.config.extension + '$', 'g'));\n                });\n            })\n            .then(filenames => Promise.all(filenames.map(this.getFileByName.bind(this))));\n    }\n};\n\nexport default ResourceFs;"]}